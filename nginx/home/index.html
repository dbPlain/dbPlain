<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.2/font/bootstrap-icons.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="index.css" />
    <script src ="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js">
    </script>
    <script src ="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js">
    </script>
        <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
        <script src="https://code.jquery.com/ui/1.13.1/jquery-ui.js"></script>
   
   <script type="text/javascript">
     
      
     
    //return null;
    
          var start = true 
          let prova = decodeURIComponent(document.cookie)
          var provasub = prova.substring(prova.indexOf("{"),prova.length)
        
          
          var datiUtente = JSON.parse(provasub).docs[0]
          console.log(datiUtente)
          
         if(datiUtente.listaDB != undefined){
          datiUtente.listaDB.forEach( datidbcookie =>{
           
            
            Connessionedb(datidbcookie.HOST, datidbcookie.DB , datidbcookie.USER , datidbcookie.PASS, datidbcookie.PORT)
    
        })}
          
          
          
          var stop = false
          var tabella=""
          var infoDB ={}
          
           $(document).ready(function(){
             
            $("#droptabelle").hide()
            $("#popupdierrore").hide()
            $("#popup-container").hide()
            $("#popup-container2").hide()
            var sidenavbar = "si"
            $("#errorpop2").hide()
           
            $("#errorpop").hide()
            $("#existpop").hide()
            document.getElementById("dropdowndb-btn").click()
            $("#show-popup-btn").click(function(){
              start = false
              $("#popupdierrore").hide()
              if(!stop){
                stop = true
                $("#popup-container").show()
              }
             })
            $("#hamburger").click(function(){

              if(sidenavbar == "si")
              {
                  sidenavbar = "no"
                  $("#sidenav").hide()

              }
              else 
              {  
                sidenavbar = "si"
                $("#sidenav").show()

              }


            })

             $("#close-btn").click(function(){
                 stop=false
                $("#popup-container").hide()})
           })
           //inserti riga
          
           function sendInsert()
           {
             
            var json = '{"'+arguments[1]+'": "' + arguments[0]+'"'
            for (var i = 2; i < arguments.length; i+=2){
              var element = arguments[i]
              var element2 = arguments[i+1]
              console.log(element2)
              
              
                   
              json =json+',"'+ element2+'": "' + element+'"'
              console.log(element)

             }
             console.log(infoDB)
             json = json + ',"HOST" : "'+ infoDB.HOST+'",'+
                                   '"DB" : "'+ infoDB.DB+'",'+
                                   '"USER" : "'+ infoDB.USER+'",'+
                                   '"PASS" : "'+ infoDB.PASS+'",'+
                                   '"PORT" : "'+ infoDB.PORT+'"}'
             console.log(json)

            
             var jsonO = JSON.parse(json)
             var richiestaInsert = new XMLHttpRequest()
             richiestaInsert.open("post", "http://localhost:8080/insertriga" , true)
             richiestaInsert.setRequestHeader("Content-Type", "application/json");
             richiestaInsert.onload = function(){

              var response = richiestaInsert.response
              if(response == "ok")
              {
                console.log("record inserito")
                console.log(tabella + jsonO.tabella)
               
                closeriga()
                if(tabella == jsonO.tabella)
                    { var tbody = document.getElementById("body")
                      var lista= []
                      var   tr2 = document.createElement("tr")
                      console.log("uguali"  )
                      for  (var  key in jsonO){
                        if(key != "HOST" && key != "DB" && key != "PORT" && key != "PASS" && key != "USER"){
                        
                        console.log(key)
                        th = document.createElement("th")
                        th.innerHTML=jsonO[key]
                        lista.push(th)
                        
                        }
                        
                      } 
                      console.log("lista = " + lista + lista.length)
                      for (var i = 1; i <lista.length; i++)
                      { 
                        
                        console.log("entrato"+lista[i].innerText)
                        tr2.appendChild(lista[i])
                      }
                      tbody.appendChild(tr2)

                    }
                else{
                    console.log("non uguali")
                 }
                stop = false
              }
              else 
              {
                console.log("errore, ricontrolla il formato dei dati inseriti" +response)
                $("#errorpop2").show()

              }
             }
              richiestaInsert.send(JSON.stringify(jsonO))
           }
           
           // aggiunge riga inserita nel db nella visualizzazione grafica
          
           // insert riga 
           function closeriga(){
            
            
           
            $("#popup-container2").hide()
            $("#errorpop2").hide()
            stop = false
        
           
     
             }
           function okriga(){
            
            
          if(true){
            $("#popup-container2").hide()
            $("#errorpop2").hide()
            stop = false
          }
           }
           function setTabella(nomeTabella){

                 tabella= nomeTabella
           }


           //setup insert righe in tabella
           function insertriga(){
            
            if(!stop && tabella != "")
            { 
              stop = true
              $("#nometab").remove()
              
              
               $("#popup-container2").empty()
               $("#popup-container2").append('<div id="close-btn2"><span>close</span></div><br/>')
               $("#popup-container2").append('<span style="float:left">inserisci riga nella tabella '+tabella+' </span><br/>')
              
              $("#close-btn2").click(function(){

                 stop=false
                $("#popup-container2").hide()
              
              
              })
              $("#testa").each(function(index,item){
            
             
              var lista = item.innerText.split('\t')
              var elementifunz = "'"+tabella+"','tabella'"
              "document.getElementById('hostDB').value"
              console.log(lista)
              lista.forEach(element => {
                elementifunz = elementifunz+",document.getElementById('"+element+"').value,'"+element+"'"
                
              $("#popup-container2").append('<span> '+element+' </span><br/>')
              $("#popup-container2").append('<input  type="text" name='+element+' class="form-control"  id='+element+' placeholder="Inserisci qualcosa" /><br/>')
              });
              
              console.log(elementifunz)
              var stringa = '<button onclick="sendInsert('+elementifunz+')" style="position: relative; margin-top:40px;margin-left: 38%;" class="btn btn-danger">invia</button>'
              console.log(stringa)
              $("#popup-container2").append('<button onclick="sendInsert('+elementifunz+')" style="position: relative; margin-top:40px;margin-left: 38%;" class="btn btn-danger">invia</button>')
              $("#popup-container2").append('<div style="margin-top: 10px;" class="alert alert-danger" id="errorpop2"> errore inserimento dati </div>')
              $("#errorpop2").hide()
            })
              $("#popup-container2").show()

            }
            else
            { 
              if(!stop)
              {
              $("#popupdierrore").show()
              }
              
              console.log("errore")
            }
   
           }
           
           function poperrore(){
             
            $("#existpop").hide()
            $("#errorpop").show()
             
           }
           function popok(dati){
             infoDB = dati
             $("#droptabelle").show()
            
             if($("#"+dati.DB + dati.HOST).length >0)
             {  if(!start){
                $("#errorpop").hide()
                $("#existpop").show()
              }
             }
             else{
              
               stop = false
               $("#dropdown2").append('<a name='+dati+' id='+dati.DB + dati.HOST+' href="#">'+dati.DB+'</a>')
               $("#"+dati.DB + dati.HOST).click(function(){
                infoDB = dati
                 
                $("#dropdown").remove()
                $("#sidenav").append('<div class="dropdown-container" id="dropdown"></div>')
                dropdowntabella(dati)})
               $("#errorpop").hide()
               $("#existpop").hide()
               $("#popup-container").hide()
            }
           
          }
function Connessionedb(hostDB, nomeDB , userDB , passwordDB, portDB){
  

  var datiDB = {"HOST" : hostDB, "DB" : nomeDB , "USER" : userDB, "PASS" : passwordDB, "PORT" : portDB }
  
 
          var aggiungi = true
          let prova = decodeURIComponent(document.cookie)
          var provasub = prova.substring(prova.indexOf("{"),prova.length)
          var datiU = JSON.parse(provasub).docs[0].listaDB
          console.log(datiU)
          if(datiU != undefined) datiU.forEach(element=>{if(element.HOST == datiDB.HOST && element.PASS == datiDB.PASS && element.DB == datiDB.DB) aggiungi = false})
          
          var richiesta =  new XMLHttpRequest()
        
          richiesta.open("post", "http://localhost:8080/connessionedb" , true)
          richiesta.setRequestHeader("Content-Type", "application/json");
          richiesta.onload = function(nomeDB){
           var response = richiesta.response  
          
           if (richiesta.response == "ok")
           {     
                 console.log(start)
                 if(!start){
                    console.log("dentro")
                   
                   var richiestaSalvataggioDB =  new XMLHttpRequest()
                   richiestaSalvataggioDB.open("post", "http://localhost:8080/updatedbutente" , true)
                   richiestaSalvataggioDB.setRequestHeader("Content-Type", "application/json");
                   richiestaSalvataggioDB.onload = function(nomeDB){  
                    
                    if (richiestaSalvataggioDB.response == "ok")
                    {
                      popok(datiDB)  
                    
                    }
                    else
                    {      console.log(richiestaSalvataggioDB.response)
                           poperrore()
                          
                   }
                  }
                   richiestaSalvataggioDB.send(JSON.stringify({"aggiungi" : aggiungi ,"username" : datiUtente.username , "password" : datiUtente.password , "db" : datiDB}))
                }
                else{
                  
                  console.log("fuori")
                  popok(datiDB)  }
           }
           else 
           {      if(!start)
                 { 
                  
                   poperrore()
                 }
                 
                   
           }

             
         }
  richiesta.send(JSON.stringify(datiDB))

}


// loop per gestire i dropdown
function eliminaRow(id)
{
  console.log("elimina" + id)
  $("#row"+id).each(function(index,item){ console.log(index + " "+ item)
  var lista = item.innerText.split('\t')
  listacut = lista.slice(1)
  console.log(listacut)

  })
  $("#row"+id).remove()
  
}

//codice che gestice la costruzione dell'html in modo dinamico 
//basandosi sulla connessione al db e la tabella selezionata
function dropdowntabella(datiDataBase)
{

var httpRequest = new XMLHttpRequest()
httpRequest.open("post", "http://localhost:8080/tabelledb" , true)
httpRequest.setRequestHeader("Content-Type", "application/json");
         httpRequest.onload = function(){
            var response = httpRequest.response
           
         var dati =  JSON.parse(response)
         var lista = dati.rows
         var drop = document.getElementById("dropdown")
         lista.forEach((item) => {
              
              
              let tabella = document.getElementById("body")
              let aCampo = document.createElement("a");
              aCampo.setAttribute("href","#")//"showtabella.html?nometabella="+item.table_name)
              aCampo.innerHTML = item.table_name
              aCampo.addEventListener("click" , function(){
                if($("#popupdierrore") != null) $("#popupdierrore").hide()
                
                setTabella(item.table_name)
                document.getElementById("testa").remove() 
               
                var tr = document.createElement("tr")
                tr.setAttribute("id", "testa")
                document.getElementById("head").appendChild(tr)
                
                document.getElementById("body").remove() 
                tr = document.createElement("tbody")
                tr.setAttribute("id", "body")
                document.getElementById("tabella").appendChild(tr)


     
                var httpRequest3 = new XMLHttpRequest()
                httpRequest3.open("post", "http://localhost:8080/selezionaDatiTabelladinamico" , true)
                httpRequest3.setRequestHeader("Content-Type", "application/json");
                httpRequest3.onload = function(){
                    
                    var response3 = httpRequest3.response
                 
                    var dati3 =  JSON.parse(response3)
                    var lista3 = dati3.rows
                    var tbody = document.getElementById("body")
                    var tr = document.getElementById("testa")
                    var t = 1 
                    var contatore = 0
                    
                    lista3.forEach((item) => {
                    
                    tr2 = document.createElement("tr")
                    tr2.setAttribute("id", "row"+contatore)
                    contatore++
                    var t2 = 1  

                      if (t == 1){
                        var th = document.createElement("th")
                        th.innerHTML=""
                        tr.appendChild(th)
                        console.log()
                       }
                      for  (var  key in item){
                        
                        if (t == 1 ){
                        
                        var th = document.createElement("th")
                        th.setAttribute("name", "colonna")
                        th.innerHTML=key
                        tr.appendChild(th)
                        if (t2 == 1 ){
                             var temp = contatore-1
                             th = document.createElement("th")
                             th.innerHTML=" <span onclick='eliminaRow("+temp+")' style='color:red'class='bi bi-trash'></span>"
                             tr2.appendChild(th)
                             t2 = 2
                             
                          }
                        th = document.createElement("th")
                        th.innerHTML=item[key]
                        tr2.appendChild(th)
                        
                        }
                        else{
                          if (t2 == 1 ){
                             th = document.createElement("th")
                             var temp = contatore-1
                             th.innerHTML=" <span onclick='eliminaRow("+temp+")' style='color:red' class='bi bi-trash'></span>"
                             tr2.appendChild(th)
                             th = document.createElement("th")
                             th.innerHTML=item[key]
                             tr2.appendChild(th)
                            t2 = 2
                          }
                          else
                          {
                             th = document.createElement("th")
                             th.innerHTML=item[key]
                             tr2.appendChild(th)
                          }
                        }
                        
                      } 
                      t=2
                      tbody.appendChild(tr2)
                     
                      //th.innerHTML=item.column_name
                     // tr.appendChild(th)
                    
                    })
                   }
                   
                   
                   setTimeout(function(){
                    var tbody = document.getElementById("testa")
                   var grandezza = tbody.offsetWidth 
                   console.log(grandezza)
                   var navbarlaterale = document.getElementById("sidenav")
                   var grandezza2 = navbarlaterale.offsetWidth
                   console.log(grandezza2)
                   var variabile = (grandezza + grandezza2) 
                   var nabvar = document.getElementById("navbarprova")
                   nabvar.setAttribute("style", "width:"+variabile +"px !important;")
                   }, 100);
                  
                // dimensiona()
                 
                var risorsePost = {"HOST" : datiDataBase.HOST, 
                                   "DB" : datiDataBase.DB,
                                   "USER" : datiDataBase.USER, 
                                   "PASS" : datiDataBase.PASS, 
                                   "PORT" : datiDataBase.PORT,
                                   "tabella": aCampo.innerText
                                    }
                httpRequest3.send(JSON.stringify(risorsePost))
                
                var divDati = document.getElementById("dati2")
                divDati.style.display="block"
         
              
              



              })
              drop.appendChild(aCampo)
             
});
         }
         httpRequest.send(JSON.stringify(datiDataBase))
}
    </script>
   

    
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

<style>

#close-btn{
  float: right;
}
#popup-container{
  position: absolute;
  left: 25%;
  top: 10%;
  width: 35%;
  height: 75%;
  padding: 20px;
  background-color: #eee;
  border: 1px solid #ccc;
  box-shadow: 0px 0px 10px #ccc;
}
#close-btn2{
  float: right;
}
#popup-container2{
  position: absolute;
  background-color: #eee;
  left: 25%;
  top: 10%;
  width: 45%;
  padding: 20px;
  border: 1px solid rgb(120, 100, 100);
  
}
body {
  font-family: "Lato", sans-serif;
}

/* Fixed sidenav, full height */
.sidenav {
  height: 100%;
  width: 200px;
  position: fixed;
  z-index: 1;
  top: 0;
  left: 0;
  background-color: #111;
  overflow-x: hidden;
  padding-top: 20px;
}

/* Style the sidenav links and the dropdown button */
.sidenav a, .dropdown-btn {
  padding: 6px 8px 6px 16px;
  text-decoration: none;
  font-size: 25px;
  color: #818181;
  display: block;
  border: none;
  background: none;
  width: 200px;
  text-align: left;
  cursor: pointer;
  outline: none;
}

/* On mouse-over */
.sidenav a:hover, .dropdown-btn:hover {
  color: #f1f1f1;
}
/* Main content */
.main2 {
  margin-left: 190px; /* Same as the width of the sidenav */
  font-size: 20px; /* Increased text to enable scrolling */
  padding: 0px 10px;
}
.main {
 margin-top: 0px;
  margin-left: 200px; /* Same as the width of the sidenav */
  font-size: 20px; /* Increased text to enable scrolling */
  padding: 0px 10px;
}

/* Add an active class to the active dropdown button */
.active {
  background-color: green;
  color: white;
}

/* Dropdown container (hidden by default). Optional: add a lighter background color and some left padding to change the design of the dropdown content */
.dropdown-container {
  display: none;
  background-color: #262626;
  padding-left: 8px;
}

/* Optional: Style the caret down icon */
.fa-caret-down {
  float: center;
  padding-right: 8px;
}

/* Some media queries for responsiveness */
@media screen and (max-height: 450px) {
  .sidenav {padding-top: 15px;}
  .sidenav a {font-size: 18px;}
}
</style>
</head>
<body>
  
  <div  class="container-fluid" id = "popup-container2">
    <div id="close-btn2">
       <span>close</span>

    </div>
  
  
    
    
  </div>


</div>
<div  id = "popup-container">
  <div id="close-btn">
     <span>close</span>
   
  </div>

  <h3 style="float:left">inserisci db</h3>
  <form style="margin-top: 70px;" action="javascript:void(0);" name="login_form" class="form-signin" >
   
        
        <span>HOST:</span>
        <input type="text" name="hostDB" class="form-control"  id="hostDB"
            placeholder="Inserisci l'host del tuo db" required autofocus /> <!-- name is required in una form (vedi su internet: differenza id e name) -->
        <span>NOME DB:</span>
        <input type="text" name="nomeDB" class="form-control" id="nomeDB"
            placeholder="inserisci password" required />
        <span>USER:</span>
        <input type="text" name="userDB" class="form-control" id="userDB"
            placeholder="inserisci password" required />
        <span>PASSWORD:</span>
        <input type="text" name="passwordDB" class="form-control" id="passwordDB"
          placeholder="inserisci password" required />
        <span>PORT:</span>
        <input type="text" name="portdDB" class="form-control" id="portDB"
            placeholder="inserisci " required />
            
       
        <button onclick="Connessionedb(document.getElementById('hostDB').value,
                                       document.getElementById('nomeDB').value,
                                       document.getElementById('userDB').value,
                                       document.getElementById('passwordDB').value,
                                       document.getElementById('portDB').value)" 
                                       style="position: relative; margin-top:40px;margin-left: 38%;" class="btn btn-danger">Connetti db</button>
        

        <div style="margin-top: 10px;" class="alert alert-danger" id="errorpop"> errore inserimento dati </div>
        <div style="margin-top: 10px;" class="alert alert-danger" id="existpop"> errore, db gi√† inserito </div>
    </form>
</div>

<div  id="sidenav"class="sidenav">
  <a href="#about">About</a>
  <a href="#contact">Search</a>
  <a href="#services">Services</a>
  <a href="#clients">Clients</a>
  <a href="#contact">Contact</a>
  
  <button id="dropdowndb-btn" class="dropdown-btn">database 
    <i class="fa fa-caret-down"></i>
  </button>
  <div class="dropdown-container" id="dropdown2">
    <a href="#" style="text-align:left;" id="show-popup-btn">+add-db</a>
  </div>
  <button id="droptabelle" class="dropdown-btn">Tabelle 
    <i class="fa fa-caret-down"></i>
  </button>
  <div class="dropdown-container" id="dropdown">
    
  </div>
  
</div>

<nav id="navbarprova"   style="width:100% !important;" class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
  <div class="container-fluid">
    <button id="hamburger"   class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarText" aria-controls="navbarText" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <a class="navbar-brand" href="#">dbPlain</a>
    
    <div class="collapse navbar-collapse" id="navbarText">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
     
      </ul>
      
    </div>
    <button onclick="insertriga()" type="button" class="btn btn-success">inserisci nuova riga </button>
    
  </nav>

<div id="dati2" class="main" style="display:none">
     
    <table     id="tabella" class="table table-bordered">
      <thead id="head">
        <tr id = "testa">
        </tr>
      </thead>
      <tbody id="body">
         
      </tbody>
    </table>
  
</div>

<div  id = "popupdierrore" style="position:relative;width:40% ; margin-left:40%; margin-top: 10%;"classs="container p-5">
  <div class="row no-gutters">
    <div >
      <div class="alert alert-danger shadow my-3" role="alert" style="border-radius: 3px">
        <button type="button" class="close" onclick='{$("#popupdierrore").hide()}' aria-label="Close">
            <span aria-hidden="True" style="color:#721C24">&times;</span>
        </button>
        <div class="text-center">
          <svg width="3em" height="3em" viewBox="0 0 16 16" class="m-1 bi bi-exclamation-circle-fill" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
            <path fill-rule="evenodd" d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM8 4a.905.905 0 0 0-.9.995l.35 3.507a.552.552 0 0 0 1.1 0l.35-3.507A.905.905 0 0 0 8 4zm.002 6a1 1 0 1 0 0 2 1 1 0 0 0 0-2z"/>
          </svg>
        </div>
        <p style="font-size:18px" class="mb-0 font-weight-light"><b class="mr-1">Errore!</b>selezionare prima una tabella</p>
      </div>
    </div>    
  

<script>


// funzione per nuova connessione db 
var dropdown = document.getElementsByClassName("dropdown-btn");
var i;

for (i = 0; i < dropdown.length; i++) {
  dropdown[i].addEventListener("click", function() {
    //var stile = "top=10, left=10, width=250, height=200, status=no,location=no,menubar = no, menubar=no, toolbar=no scrollbars=no";
    //window.open("./index.html", "", stile);
    this.classList.toggle("active");
    var dropdownContent = this.nextElementSibling;
    if(dropdownContent != null){
    if (dropdownContent.style.display === "block") {
      dropdownContent.style.display = "none";
    } else {
      dropdownContent.style.display = "block";
    }
   }
  });
}

//codice che gestice la costruzione dell'html in modo dinamico 
//basandosi sulla connessione al db e la tabella selezionata

</script>

</body>
</html> 
