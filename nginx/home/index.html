<!DOCTYPE html>
<html lang="it">
<head>
 
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.2/font/bootstrap-icons.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    
    <link rel="apple-touch-icon" sizes="180x180" href="/static/assets/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/assets/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/assets/favicon/favicon-16x16.png">
    <link rel="manifest" href="/static/assets/favicon/site.webmanifest">
    <link rel="mask-icon" href="/static/assets/favicon/safari-pinned-tab.svg" color="#60b56d">
    <meta name="msapplication-TileColor" content="#00a300">
    <meta name="theme-color" content="#60b56d">

    
   

    
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="/socket.io/socket.io.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

<style>

#close-btn{
  float: right;
}

#close-btn2{
  float: right;
}

body {
  font-family: "Lato", sans-serif;
}

/* Fixed sidenav, full height */
.sidenav {
  height: 100%;
  width: 200px;
  position: fixed;
  z-index: 1;
  top: 0;
  left: 0;
  background-color: #111;
  overflow-x: hidden;
  padding-top: 20px;
}

/* Style the sidenav links and the dropdown button */
.sidenav a, .dropdown-btn {
  padding: 6px 8px 6px 16px;
  text-decoration: none;
  font-size: 25px;
  color: #818181;
  display: block;
  border: none;
  background: none;
  width: 200px;
  text-align: left;
  cursor: pointer;
  outline: none;
}

/* On mouse-over */
.sidenav a:hover, .dropdown-btn:hover {
  color: #f1f1f1;
}
/* Main content */
.main2 {
  margin-left: 190px; /* Same as the width of the sidenav */
  font-size: 20px; /* Increased text to enable scrolling */
  padding: 0px 10px;
}
.main {
 margin-top: 10px;
  margin-left: 200px; /* Same as the width of the sidenav */
  font-size: 20px; /* Increased text to enable scrolling */
  padding: 0px 10px;
}

/* Add an active class to the active dropdown button */
.active {
  background-color: green;
  color: white;
}

/* Dropdown container (hidden by default). Optional: add a lighter background color and some left padding to change the design of the dropdown content */
.dropdown-container {
  display: none;
  background-color: #262626;
  padding-left: 8px;
}

/* Optional: Style the caret down icon */
.fa-caret-down {
  float: center;
  padding-right: 8px;
}


/* Some media queries for responsiveness */
@media screen and (max-height: 450px) {
  .sidenav {padding-top: 15px;}
  .sidenav a {font-size: 18px;}
}

@media screen and (max-width: 576px) {
  .sidenav a, .dropdown-btn{
    font-size: 15px;
  }
  .sidenav{
    width: 150px;
  }
  #dati2 {
    margin-left: 150px;
  }
  #div-iniziale {
    margin-left: 150px;
  }

  #show-popup-btn, #logout-sidebar {
    margin-left: 16% !important;
    width: 100px !important;
    font-size: 15px;
  }
}

.invisible {
  display: none;
}

#show-popup-btn {
  width:110px; margin-left: 22%; margin-bottom: 20px;
}
#logout-sidebar {
  width: 110px;margin-left: 22%;margin-bottom: 20px; margin-top:10px;
}

.modal-backdrop {
  width: 100% !important;
  height: 100% !important;
}

</style>
</head>
<body>
  

  <div class="modal fade" id="popup-container" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Aggiungi un database</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">

          <form action="javascript:void(0);">
            <div class="mb-3">
              <span>HOST:</span>
              <input type="text" name="hostDB" class="form-control"  id="hostDB"
                  placeholder="Inserisci l'host del tuo db" required autofocus />
            </div>
            <div class="mb-3">
              <span>NOME DB:</span>
              <input type="text" name="nomeDB" class="form-control" id="nomeDB"
                  placeholder="inserisci password" required />
            </div>
            <div class="mb-3">
              <span>USER:</span>
              <input type="text" name="userDB" class="form-control" id="userDB"
                  placeholder="inserisci password" required />
            </div>
            <div class="mb-3">
              <span>PASSWORD:</span>
              <input type="password" name="passwordDB" class="form-control" id="passwordDB"
                placeholder="inserisci password" required />
            </div>
            <div class="mb-3">
              <span>PORT:</span>
              <input type="text" name="portdDB" class="form-control" id="portDB"
                  placeholder="inserisci " required />
            </div>
            
            
            
            
            
                
           
            <button onclick="Connessionedb(document.getElementById('hostDB').value,
                                           document.getElementById('nomeDB').value,
                                           document.getElementById('userDB').value,
                                           document.getElementById('passwordDB').value,
                                           document.getElementById('portDB').value)" 
                                           style="position: relative; margin-top:40px;margin-left: 38%;" class="btn btn-danger" id="conneti-db-btn" type="button">Connetti db</button>
            
    
            <div style="margin-top: 10px;" class="alert alert-danger" id="errorpop"> errore inserimento dati </div>
            <div style="margin-top: 10px;" class="alert alert-danger" id="existpop"> errore, db già inserito </div>
            <!-- <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="margin-top: 40px; margin-left: 15%;">Close</button> -->
          </form>

        </div>
      </div>
    </div>
  </div>





  <div class="modal fade" id="inserisci-riga" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Aggiungi una riga</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">

          <div  class="container-fluid" id = "popup-container2">

            

          </div>

        </div>
      </div>
    </div>
  </div>

<div id="popup-container">

 
</div>

<div  id="sidenav"class="sidenav">
  
  <br><br>
  <button type="button" class="btn btn-danger" id="logout-sidebar" onclick="logout()">
    <i class="fa fa-sign-out" aria-hidden="true"></i> Logout
  </button>

  <button href="" class="btn btn-success" type="button" id="show-popup-btn"
    data-bs-toggle="modal" data-bs-target="#popup-container" data-bs-toggle="modal">aggiungi database</button>

  <button id="dropdowndb-btn" class="dropdown-btn">database 
    <i class="fa fa-caret-down"></i>
  </button>
  <div class="dropdown-container" id="dropdown2"></div>
  <button id="droptabelle" class="dropdown-btn">Tabelle 
    <i class="fa fa-caret-down"></i>
  </button>
  <div class="dropdown-container" id="dropdown">
    
  </div>
  
</div>

<nav id="navbarprova"   style="width:100% !important;" class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
  <div class="container-fluid">
    <button id="hamburger"   class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarText" aria-controls="navbarText" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <a class="navbar-brand" href="/static/" style="margin-right: 0em;">
      <!-- dbPlain -->
      <img src="../assets/img/logo+nome_dbplain_negativo.png" alt="" style="max-width:100%;height:30px;margin-bottom:2px;">
    </a>
    
    <button type="button" class="btn btn-success" onclick="redirect_tabelle()">tabella</button>

    <button onclick="insertriga()" type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#inserisci-riga" id="inseriscirigabutton">inserisci nuova riga</button>
    
  </nav>


  <div class="main" id='div-iniziale'>

    
    <div class="d-flex justify-content-center" >

      <div class="d-flex justify-content-around flex-column"style="width: 30rem !important;max-width: 100% !important;">
        <div class="card" style=" background-color:#E7F7CC;max-width: 100% !important;">
          <div class="card-body" >
            <h5 class="card-title" > <strong id="titolo">Ciao!</strong> </h5>
            <br>
            
            <p class="card-text"> In questa pagina puoi visualizzare e lavorare su tutti i tuoi database in modo semplice e veloce</p>
            
            <button type="button"  id="pop-trigger"class="btn btn-outline-success">Aggiugni un db ora!</button>
           
          </div>
        </div>

        <div class="card" style="background-color:#E7F7CC;max-width: 100% !important;" >
          <div class="card-body">
            <h5 class="card-title"><strong>Gestisci tutte le tue tabelle</strong></h5>
            <br>
            <p class="card-text">Una volta aggiunto e selezionato un database avrai la possibilià di gestire tutte le tabelle al suo interno</p>

          </div>
        </div>
      </div>
    </div>
      
   
    
  </div>

<div id="dati2" class="main" style="display:none">

    <table     id="tabella" class="table table-bordered">
      <thead id="head">
        <tr id = "testa">
        </tr>
      </thead>
      <tbody id="body">
         
      </tbody>
    </table>
  
</div>  
  
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js" integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF" crossorigin="anonymous"></script>
    
    <script src ="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src ="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
    <script src="https://code.jquery.com/ui/1.13.1/jquery-ui.js"></script>
   <script type="text/javascript"> 
      


         
        //variabile globali file  home
       
        var socket = io.connect("http://localhost:8080")
            socket.on("connesso", (arg)=>
               {console.log(arg)
                })
            socket.on("disconnect", (arg) =>{
	             
	              console.log("disconnesso")
              })
           
          var contatore_riga = 0;
          var nome = ""
          var start = true 
          let prova = decodeURIComponent(document.cookie)
          var provasub = prova.substring(prova.indexOf("{"),prova.length)
          try {
            datiUtente = JSON.parse(provasub).docs[0]
            nome = datiUtente.username
            
          } catch(e) {
            datiUtente = {};
            
            console.log( JSON.stringify(e) );
          }
         
          
         if(datiUtente.listaDB != undefined){
          datiUtente.listaDB.forEach( datidbcookie =>{
           
            
            Connessionedb(datidbcookie.HOST, datidbcookie.DB , datidbcookie.USER , datidbcookie.PASS, datidbcookie.PORT)
    
        })}
          
          
          
         
          var tabella=""
          var infoDB ={}
          var infoDB2 ={}
          
          var size_big = false;
           


            //inizio codice jquery
           $(document).ready(function(){

            //configurazioni generali funzionamento jquery 
            $("#titolo").text("Ciao "+nome+"!")
            const mediaQuery = window.matchMedia('(max-width: 576px)')
            const mediaQuery2 = window.matchMedia('(max-width: 991px)')
            if (mediaQuery.matches) {
              
              $('#inseriscirigabutton').html('+')
            } else {
                $('#inseriscirigabutton').html('Inserisci riga')
            }

            $("#pop-trigger").click(function(){

              $("#show-popup-btn").trigger("click")
            })


            //funzioni per la gestione dinamica degli elementi della pagina al variare della size 
            $(window).on('resize', function(){

              if (mediaQuery2.matches) {
                size_big = false;
              } else {
                size_big = true;
                $('#hamburger').trigger('click');
              }

              if (mediaQuery.matches) {
                $('#inseriscirigabutton').html('+')
                $('#div-iniziale').attr('style', 'margin-left:150px')
                $('#dati2').attr('style', 'margin-left:150px')
                var navbarlaterale = document.getElementById("sidenav")
                var grandezza2 = navbarlaterale.offsetWidth
                if ( grandezza2 ==0 ) {
                  $('#div-iniziale').attr('style', 'margin-left:0px')
                  $('#dati2').attr('style', 'margin-left:0px')
                }
              } else {
                
                $('#inseriscirigabutton').html('Inserisci riga')
                $('#div-iniziale').attr('style', 'margin-left:200px')
                $('#dati2').attr('style', 'margin-left:200px')
                var navbarlaterale = document.getElementById("sidenav")
                var grandezza2 = navbarlaterale.offsetWidth
                if ( grandezza2 ==0 ) {
                  $('#div-iniziale').attr('style', 'margin-left:0px')
                  $('#dati2').attr('style', 'margin-left:0px')
                }
              }

              

              setTimeout(function(){
                   var tbody = document.getElementById("testa")
                   var grandezza = tbody.offsetWidth 
                   
                   if (grandezza==0){
                      
                      grandezza = document.getElementById('div-iniziale').offsetWidth - 21;
                      
                   }
                   var navbarlaterale = document.getElementById("sidenav")
                   var grandezza2 = navbarlaterale.offsetWidth
                 
                   var variabile = (grandezza + grandezza2 + 21) 
                   var nabvar = document.getElementById("navbarprova")
                   nabvar.setAttribute("style", "width:"+variabile +"px !important;")
                   }, 50);
            });
             

            //gestion popup e messaggi di errore 


            $('#inseriscirigabutton').hide()

            $("#droptabelle").hide()
            $("#popupdierrore").hide()
            var sidenavbar = "si"
            $("#errorpop2").hide()
           
            $("#errorpop").hide()
            $("#existpop").hide()
            document.getElementById("dropdowndb-btn").click()
            $("#show-popup-btn").click(function(){
              start = false
              $("#popupdierrore").hide()

                $("#popup-container").show()

             })

             //gestione sidebar


            $("#hamburger").click(function(){
             
              if(sidenavbar == "si" && !size_big)
              {
                  sidenavbar = "no"
                  $("#sidenav").hide()
                  $('#dati2').attr('style', 'margin-left:0')
                  $('#div-iniziale').attr('style', 'margin-left:0');
                  setTimeout(function(){
                   var tbody = document.getElementById("testa")
                   var grandezza = tbody.offsetWidth 
                   var navbarlaterale = document.getElementById("sidenav")
                   var grandezza2 = navbarlaterale.offsetWidth
                   var variabile = (grandezza  + 21) 
                   var nabvar = document.getElementById("navbarprova")
                   nabvar.setAttribute("style", "width:"+variabile +"px !important;")
                   }, 50);

              }
              else 
              {  
                sidenavbar = "si"
                $("#sidenav").show()
                if ( mediaQuery.matches ) {
                  $('#dati2').attr('style', 'margin-left:150px')
                  $('#div-iniziale').attr('style', 'margin-left:150px')
                }
                else {
                  $('#dati2').attr('style', 'margin-left:200px')
                  $('#div-iniziale').attr('style', 'margin-left:200px')
                }

                setTimeout(function(){
                   var tbody = document.getElementById("testa")
                   var grandezza = tbody.offsetWidth 
                   var navbarlaterale = document.getElementById("sidenav")
                   var grandezza2 = navbarlaterale.offsetWidth
                   var variabile = (grandezza + grandezza2  + 21) 
                   var nabvar = document.getElementById("navbarprova")
                   nabvar.setAttribute("style", "width:"+variabile +"px !important;")
                   }, 50);
              }


            })

             $("#close-btn").click(function(){
                $("#popup-container").hide()})
           })


          //funzione delete righe (anche sul db) 


          function sendDelete(listaCampi, listaValori)
          {
          var input = {"HOST" : infoDB.HOST, "DB" : infoDB.DB , "USER" : infoDB.USER, "PASS" : infoDB.PASS, "PORT" : infoDB.PORT,
          "LISTAVALORI" : listaValori, "LISTACAMPI" : listaCampi , "TABELLA" : tabella
        
        
        }
          var richiestaDelete = new XMLHttpRequest()
             richiestaDelete.open("post", "http://localhost:8080/deleteriga" , true)
             richiestaDelete.setRequestHeader("Content-Type", "application/json");
             richiestaDelete.onload = function()
             {
              var risposta=richiestaDelete.response
             }
             richiestaDelete.send(JSON.stringify(input))
          }



           //funzione inserisci righe (lato back-end database)
          
           function sendInsert()
           {
            contatore_riga++;

            var json = '{"'+arguments[1]+'": "' + arguments[0]+'"'
            for (var i = 2; i < arguments.length; i+=2){
              var element = arguments[i]
              var element2 = arguments[i+1]

              
              
                   
              json =json+',"'+ element2+'": "' + element+'"'

             }
             json = json + ',"HOST" : "'+ infoDB.HOST+'",'+
                                   '"DB" : "'+ infoDB.DB+'",'+
                                   '"USER" : "'+ infoDB.USER+'",'+
                                   '"PASS" : "'+ infoDB.PASS+'",'+
                                   '"PORT" : "'+ infoDB.PORT+'"}'


            
             var jsonO = JSON.parse(json)
             console.log(json)

             socket.emit("sendinsert", json)
             socket.on("send-insert-response" ,(response) => {
              console.log(response)
              if(response == "ok")
              {
               
                  
                closeriga()
                if(tabella == jsonO.tabella)
                    { var tbody = document.getElementById("body")
                      var lista= []
                      var   tr2 = document.createElement("tr")
                     
                      var th = document.createElement("th")
                      th.innerHTML=" <span onclick='eliminaRow("+-1+")' style='color:red' class='bi bi-trash'></span>"
                    
                      if ((contatore_riga-1)%2 == 0 ) th.setAttribute('style', 'font-weight:normal; background-color: #E7F7CC;')
                      else th.setAttribute('style', 'font-weight:normal')
                      tr2.appendChild(th)
                      for  (var  key in jsonO){
                        if(key != "HOST" && key != "DB" && key != "PORT" && key != "PASS" && key != "USER"){
                        
        
                        th = document.createElement("th")
                        th.innerHTML=jsonO[key]
                        if ((contatore_riga-1)%2 == 0) th.setAttribute('style', 'font-weight:normal; background-color: #E7F7CC;')
                        else th.setAttribute('style', 'font-weight:normal')
                        lista.push(th)
                        
                        }                       
                      }                      
                      for (var i = 1; i <lista.length; i++)
                      {                                            
                        tr2.appendChild(lista[i])
                      }
                      tbody.appendChild(tr2)

                    }
                else{                 
                 }
              }
              else 
              {
                console.log("errore, ricontrolla il formato dei dati inseriti" +response)
                $("#errorpop2").show()
              }

             })
             /*var richiestaInsert = new XMLHttpRequest()
             richiestaInsert.open("post", "http://localhost:8080/insertriga" , true)
             richiestaInsert.setRequestHeader("Content-Type", "application/json");
             richiestaInsert.onload = function(){

              var response = richiestaInsert.response
              if(response == "ok")
              {
               
               
                closeriga()
                if(tabella == jsonO.tabella)
                    { var tbody = document.getElementById("body")
                      var lista= []
                      var   tr2 = document.createElement("tr")
                     
                      var th = document.createElement("th")
                      th.innerHTML=" <span onclick='eliminaRow("+-1+")' style='color:red' class='bi bi-trash'></span>"
                    
                      if ((contatore_riga-1)%2 == 0 ) th.setAttribute('style', 'font-weight:normal; background-color: #E7F7CC;')
                      else th.setAttribute('style', 'font-weight:normal')
                      tr2.appendChild(th)
                      for  (var  key in jsonO){
                        if(key != "HOST" && key != "DB" && key != "PORT" && key != "PASS" && key != "USER"){
                        
        
                        th = document.createElement("th")
                        th.innerHTML=jsonO[key]
                        if ((contatore_riga-1)%2 == 0) th.setAttribute('style', 'font-weight:normal; background-color: #E7F7CC;')
                        else th.setAttribute('style', 'font-weight:normal')
                        lista.push(th)
                        
                        }                       
                      }                      
                      for (var i = 1; i <lista.length; i++)
                      {                                            
                        tr2.appendChild(lista[i])
                      }
                      tbody.appendChild(tr2)

                    }
                else{                 
                 }
              }
              else 
              {
                console.log("errore, ricontrolla il formato dei dati inseriti" +response)
                $("#errorpop2").show()
              }
             }
              richiestaInsert.send(JSON.stringify(jsonO))*/
           }
           

           // aggiunge riga inserita nel db nella visualizzazione grafica
          

           function closeriga(){

            $("#errorpop2").hide()
             }
           function okriga(){
            
            
          if(true){
            $("#errorpop2").hide()
          }
           }
           function setTabella(nomeTabella){

                 tabella= nomeTabella
           }


           //setup popup insert righe in tabella

           function insertriga(){
            
            if(tabella != "")
            { 
              $("#nometab").remove()
              
              
               $("#popup-container2").empty()
               $("#popup-container2").append('<span style="float:left">inserisci riga nella tabella \"'+tabella+'\" </span><br/><br/>')
              
              $("#close-btn2").click(function(){

              
              
              })

              
              $("#testa").each(function(index,item){
            
              
                var lista = item.innerText.split('\t')
                var elementifunz = "'"+tabella+"','tabella'"
                "document.getElementById('hostDB').value"
                var flag = 1;
                lista.forEach(element => {
                  if (flag!=1) {
                    elementifunz = elementifunz+",document.getElementById('"+element+"').value,'"+element+"'"
                    
                    $("#popup-container2").append('<span> '+element+' </span><br/>')
                    $("#popup-container2").append('<input  type="text" name='+element+' class="form-control"  id='+element+' placeholder="Inserisci qualcosa" /><br/>')
                    }
                    flag =2;
                  });
                
                var stringa = '<button onclick="sendInsert('+elementifunz+')" style="position: relative; margin-top:40px;margin-left: 38%;" class="btn btn-danger">invia</button>'
                $("#popup-container2").append('<button onclick="sendInsert('+elementifunz+')" data-bs-dismiss="modal" style="position: relative; margin-top:40px;margin-left: 38%;" class="btn btn-danger">invia</button>')
                $("#popup-container2").append('<div style="margin-top: 10px;" class="alert alert-danger" id="errorpop2"> errore inserimento dati </div>')
                $("#errorpop2").hide()
            
            })
              $("#popup-container2").show()

            }
            else
            { 
              $("#popupdierrore").show()
            }
   
           }
           
           //gestione errore nella popup aggiugni db
           function poperrore(){
             
            $("#existpop").hide()
            $("#errorpop").show()
             
           }

            //gestione ok nella popup aggiugni db

           function popok(dati){
             infoDB = dati
             $("#droptabelle").show()
            
             if($("#"+dati.DB + dati.HOST).length >0)
             {  if(!start){
                $("#errorpop").hide()
                $("#existpop").show()
              }
             }
             else{
              
              $('#conneti-db-btn').attr('data-bs-dismiss',"modal")
              $('#conneti-db-btn').trigger( "click" );
              $('#conneti-db-btn').removeAttr('data-bs-dismiss')

               $("#dropdown2").append('<a name='+dati+' id='+dati.DB + dati.HOST+' href="#">'+dati.DB+'</a>')
               $("#"+dati.DB + dati.HOST).click(function(){
                 // infoDB = dati
                  infoDB2 = dati 
                  // tiene illuminato il database selezionato
                  $("#dropdown2").children().css({
                      "color": "", 
                  });
                  $("#"+dati.DB + dati.HOST).css({
                      "color": "#f1f1f1",
                  });

                  $("#dropdown").remove()
                  $("#sidenav").append('<div class="dropdown-container" id="dropdown"></div>')
                  dropdowntabella(dati)})
                $("#errorpop").hide()
                $("#existpop").hide()
                $("#popup-container").hide()
            }
           
          }

//funzione che permette la connessione con i db (gestendo eventuali errori) sia al login che alla popup di insert

function Connessionedb(hostDB, nomeDB , userDB , passwordDB, portDB){
  

  var datiDB = {"HOST" : hostDB, "DB" : nomeDB , "USER" : userDB, "PASS" : passwordDB, "PORT" : portDB }
  
 
          var aggiungi = true
          let prova = decodeURIComponent(document.cookie)
          var provasub = prova.substring(prova.indexOf("{"),prova.length)
          var datiU = JSON.parse(provasub).docs[0].listaDB
          if(datiU != undefined) datiU.forEach(element=>{if(element.HOST == datiDB.HOST && element.PASS == datiDB.PASS && element.DB == datiDB.DB) aggiungi = false})
          
          var richiesta =  new XMLHttpRequest()
        
          richiesta.open("post", "http://localhost:8080/connessionedb" , true)
          richiesta.setRequestHeader("Content-Type", "application/json");
          richiesta.onload = function(nomeDB){
           var response = richiesta.response  
          
           if (richiesta.response == "ok")
           {     

                 if(!start){
                   
                   var richiestaSalvataggioDB =  new XMLHttpRequest()
                   richiestaSalvataggioDB.open("post", "http://localhost:8080/updatedbutente" , true)
                   richiestaSalvataggioDB.setRequestHeader("Content-Type", "application/json");
                   richiestaSalvataggioDB.onload = function(nomeDB){  
                    
                    if (richiestaSalvataggioDB.response == "ok")
                    {
                      popok(datiDB)  
                    
                    }
                    else
                    {      
                           poperrore()
                          
                   }
                  }
                   richiestaSalvataggioDB.send(JSON.stringify({"aggiungi" : aggiungi ,"username" : datiUtente.username , "password" : datiUtente.password , "db" : datiDB}))
                }
                else{
                  
                 
                  popok(datiDB)  }
           }
           else 
           {      if(!start)
                 { 
                  
                   poperrore()
                 }                  
           }            
         }
  richiesta.send(JSON.stringify(datiDB))

}


// loop per gestire i dropdown
function eliminaRow(id)
{

  var listaValori;
  $("#row"+id).each(function(index,item){ 
  lista = item.innerText.split('\t')
  listaValori = lista.slice(1)
  


  })
  var listaCampi;
  
  $("#testa").each(function(index,item){ 
  lista = item.innerText.split('\t')
  listaCampi = lista.slice(1)
 

  

  })


  $("#row"+id).remove()
  sendDelete(listaCampi,listaValori);
  
}

//codice che gestice la costruzione dell'html in modo dinamico del dropdown tabella
//basandosi sulla connessione al db e la tabella selezionata
function dropdowntabella(datiDataBase)
{



var httpRequest = new XMLHttpRequest()
httpRequest.open("post", "http://localhost:8080/tabelledb" , true)
httpRequest.setRequestHeader("Content-Type", "application/json");
         httpRequest.onload = function(){
            var response = httpRequest.response
           
         var dati =  JSON.parse(response)
         var lista = dati.rows
         var drop = document.getElementById("dropdown")
         lista.forEach((item) => {
              
              
              let tabella = document.getElementById("body")
              let aCampo = document.createElement("a");
              aCampo.setAttribute("href","#")//"showtabella.html?nometabella="+item.table_name)
              aCampo.innerHTML = item.table_name
              aCampo.setAttribute('id', item.table_name + '202')
              aCampo.addEventListener("click" , function(){
                infoDB = infoDB2
                $('#inseriscirigabutton').show()
                if($("#popupdierrore") != null) $("#popupdierrore").hide()

                contatore_riga = 0;

                $('#div-iniziale').addClass('invisible')

                setTabella(item.table_name)
                document.getElementById("testa").remove()
                
                  
                  // tiene illuminato la tabella selezionata
                  $("#dropdown").children().css({
                      "color": "", 
                  });
                  $("#"+item.table_name+'202').css({
                      "color": "#f1f1f1",
                  });
               
                var tr = document.createElement("tr")
                tr.setAttribute("id", "testa")
                document.getElementById("head").appendChild(tr)
                
                document.getElementById("body").remove() 
                tr = document.createElement("tbody")
                tr.setAttribute("id", "body")
                document.getElementById("tabella").appendChild(tr)


     
                var httpRequest3 = new XMLHttpRequest()
                httpRequest3.open("post", "http://localhost:8080/selezionaDatiTabelladinamico" , true)
                httpRequest3.setRequestHeader("Content-Type", "application/json");
                httpRequest3.onload = function(){
                    
                    var response3 = httpRequest3.response
                 
                    var dati3 =  JSON.parse(response3)
                    var lista3 = dati3.rows
                    var tbody = document.getElementById("body")
                    var tr = document.getElementById("testa")
                    var t = 1 
                    var contatore = 0
                    
                    lista3.forEach((item) => {
                    
                    tr2 = document.createElement("tr")
                    tr2.setAttribute("id", "row"+contatore)
                    contatore++
                    var t2 = 1  

                      if (t == 1){
                        var th = document.createElement("th")
                        th.innerHTML=""
                        th.setAttribute('style', 'width: 10px; background-color: #BEE7C5')
                        tr.appendChild(th)
                        
                        
                       }
                      for  (var  key in item){
                        
                        if (t == 1 ){
                        
                          var th = document.createElement("th")
                          th.setAttribute("name", "colonna")
                          th.setAttribute("style", "background-color: #BEE7C5") // style nome colonne
                          th.innerHTML=key
                          tr.appendChild(th)
                          if (t2 == 1 ){
                              var temp = contatore-1
                              th = document.createElement("th")
                              th.innerHTML=" <span onclick='eliminaRow("+temp+")' style='color:red;'class='bi bi-trash'></span>"
                              th.setAttribute('style', 'background-color:#E7F7CC')
                              tr2.appendChild(th)
                              t2 = 2
                              
                            }
                            
                          th = document.createElement("th")
                          th.innerHTML=item[key]
                          // style prima riga della tabella
                          th.setAttribute('style', 'font-weight:normal; background-color: #E7F7CC')
                          tr2.appendChild(th)

                          
                        }
                        else{
                          if (t2 == 1 ){
                             th = document.createElement("th")
                             var temp = contatore-1
                             th.innerHTML=" <span onclick='eliminaRow("+temp+")' style='color:red' class='bi bi-trash'></span>"
                             if (contatore_riga%2 == 0) th.setAttribute('style', 'background-color: #E7F7CC;')
                             tr2.appendChild(th)
                             th = document.createElement("th")
                             th.innerHTML=item[key]
                             // style prima colonna di ogni riga della tabella
                            if (contatore_riga%2 == 0) th.setAttribute('style', 'font-weight:normal; background-color: #E7F7CC;')
                            else th.setAttribute('style', 'font-weight:normal')
                             tr2.appendChild(th)
                            t2 = 2
                            
                          }
                          else
                          {
                             th = document.createElement("th")
                             th.innerHTML=item[key]
                             // style resto delle colonne per ogni riga della tabella
                             if (contatore_riga%2 == 0) th.setAttribute('style', 'font-weight:normal; background-color: #E7F7CC;')
                             else th.setAttribute('style', 'font-weight:normal')
                             tr2.appendChild(th)

                             
                          }
                        }
                        
                        
                      } 

                      contatore_riga++;

                      t=2
                      tbody.appendChild(tr2)
                     

                    })
                   }
                  
                var risorsePost = {"HOST" : datiDataBase.HOST, 
                                   "DB" : datiDataBase.DB,
                                   "USER" : datiDataBase.USER, 
                                   "PASS" : datiDataBase.PASS, 
                                   "PORT" : datiDataBase.PORT,
                                   "tabella": aCampo.innerText
                                    }
                httpRequest3.send(JSON.stringify(risorsePost))
                
                var divDati = document.getElementById("dati2")
                divDati.style.display="block"
         
                setTimeout(function(){
                   var tbody = document.getElementById("testa")
                   var grandezza = tbody.offsetWidth 
                   var navbarlaterale = document.getElementById("sidenav")
                   var grandezza2 = navbarlaterale.offsetWidth
                   var variabile = (grandezza + grandezza2 + 21) 
                   var nabvar = document.getElementById("navbarprova")
                   nabvar.setAttribute("style", "width:"+variabile +"px !important;")
                   var dimensione_ = document.getElementById("popup-container")
                   }, 250);                 
              })

              drop.appendChild(aCampo)
             
});

         

         }
         httpRequest.send(JSON.stringify(datiDataBase))


         $('#droptabelle').trigger('click');
         $('#droptabelle').addClass('active');
}

//gestisce la pulizia dei cookie in caso di logout 

function logout(){
  setCookie('datiUtente', '', -1);
  window.location.replace('/static/');
}

//supporta la funzione logout nella pulizia dei cookie 
function setCookie(cname, cvalue, exdays) {
	const d = new Date();
	d.setTime(d.getTime() + (exdays*24*60*60*1000));
	let expires = "expires="+ d.toUTCString();
	document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
}


function redirect_tabelle(){
  window.location.href = '/static/home/tabella.html?tabella='+tabella; //+'&infodb='+JSON.stringify(infoDB)
}

    </script>
   
<script>

var dropdown = document.getElementsByClassName("dropdown-btn");
var i;

//gestione dropdown database

for (i = 0; i < dropdown.length; i++) {
  dropdown[i].addEventListener("click", function() {
 
    this.classList.toggle("active");
    var dropdownContent = this.nextElementSibling;
    if(dropdownContent != null){
    if (dropdownContent.style.display === "block") {
      dropdownContent.style.display = "none";
    } else {
      dropdownContent.style.display = "block";
    }
   }
  });
}

</script>









</body>
</html> 
